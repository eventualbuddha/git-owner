#!/usr/bin/env node

/* jshint node:true, undef:true, unused:true */

var file;
var format;
var gitBlameStats = require('../lib').gitBlameStats;

function main() {
  parseArguments();
  processFile(file, function(err, stats) {
    if (err) { throw err; }

    if (format === 'json') {
      console.log(stats.committers.map(function(pair) {
        return pair[1];
      }));
    } else {
      var maxPercentage = stats.committers.reduce(function(max, pair) {
        return Math.max(max, pair[0]);
      }, 0);

      stats.committers.forEach(function(pair) {
        var percentage = ''+pair[0];
        var committer = pair[1];

        console.log(
          '%s%s% %s',
          new Array((''+maxPercentage).length - percentage.length + 1).join(' '),
          percentage,
          committer.email
        );
      });

      console.log();
      if (stats.pairedLines > 0) {
        console.log('%s lines, %s paired.', stats.totalLines, stats.pairedLines);
      } else {
        console.log('%s lines.', stats.totalLines);
      }
    }
});
}

function parseArguments() {
  var args = process.argv.slice(2);
  var arg;

  while ((arg = args.shift())) {
    if (arg === '-h' || arg === '--help') {
      usage(0);
    } else if (arg === '-f' || arg === '--format') {
      var next = args.shift();
      if (!next) {
        usage(1);
      } else {
        next = next.toLowerCase();
      }
      if (next !== 'json') {
        usage(1);
      }
      format = next;
    } else if (arg[0] === '-') {
      usage(1);
    } else if (!file) {
      file = arg;
    } else {
      usage(1);
    }
  }

  if (!file) {
    usage(1);
  }
}

function usage(code) {
  console.error('git owner [-f JSON] FILE');
  if (typeof code !== 'undefined') {
    process.exit(code);
  }
}

function processFile(file, callback) {
  gitBlameStats(file, function(err, stats) {
    if (err) {
      return callback(err);
    }

    stats.committers = stats.committers
      .sort(function(c1, c2) { return c2.lines - c1.lines; })
      .map(function(committer) {
        var percentage = Math.round(
          100 * committer.lines / stats.totalLines
        );
        return [percentage, committer];
      });

    callback(null, stats);
  });
}

main();
